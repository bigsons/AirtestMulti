<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>Airtest Test Report {{info.title}}</title>
    <script src="{{static_root}}js/jquery-1.10.2.min.js"></script>
    <script src="{{ static_root }}js/jquery-lang.js" charset="utf-8" type="text/javascript"></script>
    <script src="{{ static_root }}js/langpack/zh_CN.js" charset="utf-8" type="text/javascript"></script>
    <script src="{{ static_root }}js/lazyload.js" charset="utf-8" type="text/javascript"></script>
    <link href="{{static_root}}css/monokai_sublime.min.css" rel="stylesheet">
    
    <style type="text/css">
        /* Final Optimized Report Theme by Gemini */
        :root {
            --bg-color: #f0f2f5;
            --container-bg: #ffffff;
            --border-color: #e8e8e8;
            --shadow-color: rgba(0, 0, 0, 0.08);
            --primary-color: #1890ff;
            --primary-hover-color: #40a9ff;
            --text-color: #333;
            --text-color-secondary: #888;
            --success-color: #52c41a;
            --fail-color: #f5222d;
            --code-bg: #fafafa;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            font-size: 14px;
            line-height: 1.6;
            color: var(--text-color);
            background-color: var(--bg-color);
            margin: 0;
            min-width: 700px; /* 设置最小宽度 */
        }

        .container-fluid {
            max-width: 1600px;
            margin: 20px auto;
            background: var(--container-bg);
            border-radius: 8px;
            box-shadow: 0 4px 12px var(--shadow-color);
            border: 1px solid var(--border-color);
            padding: 20px 30px;
        }
        
        h1.title {
            font-size: 28px;
            font-weight: 600;
            text-align: center;
            color: var(--primary-color);
            padding-bottom: 20px;
            margin: 10px 0 25px 0;
            border-bottom: 1px solid var(--border-color);
        }

        .summary {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 25px;
            margin-bottom: 25px;
        }
        
        .summary .info-block {
            flex: 1 1 400px; /* Flex grow, shrink, basis */
            display: flex;
            align-items: center;
            gap: 20px;
        }
        
        .summary .info-icon img {
            width: 48px;
            height: 48px;
        }
        
        .summary .info-text .info-title {
            font-size: 16px;
            font-weight: 500;
            margin-bottom: 8px;
        }
        
        .summary .info-text .info-value {
            font-size: 14px;
            color: var(--text-color-secondary);
        }

        .summary .info-text .info-value strong {
            color: var(--text-color);
            font-weight: 500;
        }

        #result-desc {
            padding: 4px 12px;
            border-radius: 12px;
            color: #fff;
            font-size: 14px;
            margin-left: 10px;
        }
        
        #result-desc.success { background-color: var(--success-color); }
        #result-desc.fail { background-color: var(--fail-color); }

        .steps-container {
            display: flex;
            gap: 0;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            box-shadow: 0 2px 8px var(--shadow-color);
            overflow: hidden;
            height: calc(100vh - 320px);
            min-height: 500px;
        }

        .step-left {
            flex: 0 0 420px; /* 稍宽一点以容纳新信息 */
            border-right: 1px solid var(--border-color);
            overflow-y: auto;
            background: #fdfdfd;
        }

        .step-right {
            flex: 1;
            padding: 0;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }
        
        .step-list { list-style: none; padding: 0; margin: 0; }
        .step-list li {
            padding: 10px 15px;
            cursor: pointer;
            border-bottom: 1px solid var(--border-color);
            transition: background-color 0.2s;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .step-list li:hover { background-color: #f0f8ff; }
        .step-list li.active { background-color: var(--primary-color); color: #fff; }
        .step-list li.active .order,
        .step-list li.active .step-title, 
        .step-list li.active .step-time { color: #fff; }

        .step-list .order {
            font-size: 13px;
            color: #a0a0a0;
            white-space: nowrap;
        }

        .step-list .step-icon {
            width: 18px;
            height: 18px;
            flex-shrink: 0;
        }

        .step-list .step-title {
            flex-grow: 1;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        .step-list .step-time {
            color: var(--text-color-secondary);
            font-size: 12px;
            white-space: nowrap;
        }
        
        .step-right-header {
            padding: 15px 20px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #fafafa;
            flex-shrink: 0;
        }
        
        .step-title-display {
            font-size: 18px;
            font-weight: 600;
            flex: 1;
            min-width: 0;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .step-filters { flex-shrink: 0; }
        .step-filters .filter {
            cursor: pointer;
            padding: 6px 16px;
            border-radius: 15px;
            margin-left: 10px;
            font-size: 13px;
            border: 1px solid #d9d9d9;
            transition: all 0.2s;
        }
        .step-filters .filter:hover {
            border-color: var(--primary-hover-color);
            color: var(--primary-hover-color);
        }
        .step-filters .filter.active {
            background-color: var(--primary-color);
            color: #fff;
            border-color: var(--primary-color);
        }
        #jump-wrong {
            background-color: var(--fail-color);
            color: white;
            border-color: var(--fail-color);
        }
        
        .step-detail-container {
            padding: 25px;
            overflow-y: auto;
            flex-grow: 1;
        }
        
        .step-detail .code-line, .step-detail .log-line, .step-detail .traceback, .step-detail .assert, .step-detail .args-line {
            margin-bottom: 20px;
        }
        
        .step-detail strong {
            display: block;
            margin-bottom: 10px;
            font-size: 15px;
            color: var(--text-color);
        }
        
        pre {
            padding: 15px;
            border-radius: 6px;
            white-space: pre-wrap;
            word-wrap: break-word;
            margin: 0;
            font-family: "SFMono-Regular", Consolas, "Liberation Mono", Menlo, Courier, monospace;
            font-size: 13px;
            border: 1px solid var(--border-color);
            background: var(--code-bg);
        }
        
        .step-detail .log-line pre, .step-detail .traceback pre { background-color: #272822; color: #f8f8f2; }
        .step-detail .assert { display: none; }
        
        .step-detail .fancybox {
            position: relative;
            display: inline-block;
            margin-top: 10px;
        }
        .step-detail img, .step-detail .crop_image {
            max-width: 100%;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            cursor: zoom-in;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .target {
            position: absolute;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border: 2px solid rgba(255, 0, 0, 0.7);
            box-sizing: border-box;
            animation: target-pulse 1.5s infinite ease-out;
        }

        .rect {
            position: absolute;
            border: 2px solid #ff0000;
            background-color: rgba(255,0,0,0.2);
        }

        @keyframes target-pulse {
            0% { transform: scale(0.8); opacity: 1; }
            100% { transform: scale(2.5); opacity: 0; }
        }

        #magnify {
            position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
            background: rgba(0,0,0,0.85); z-index: 1000;
            display: none; justify-content: center; align-items: center;
            cursor: zoom-out;
        }
        #magnify img { max-width: 95%; max-height: 95%; border: 2px solid #fff; border-radius: 5px; }

        @media (max-width: 1200px) { .step-left { flex: 0 0 320px; } }
        @media (max-width: 992px) {
            .steps-container { flex-direction: column; height: auto; }
            .step-left { flex-basis: auto; border-right: none; border-bottom: 1px solid var(--border-color); max-height: 300px; }
            .step-right { flex-basis: auto; max-height: 60vh; }
        }
    </style>
</head>

<body>
    <div class="container-fluid">
        <h1 class="title" lang="en">Airtest自动化测试报告</h1>

        <div class="summary">
            <div class="info-block">
                <div class="info-icon">
                    <img id="result-img" src="" alt="result">
                </div>
                <div class="info-text">
                    <div class="info-title">
                        <span lang='en'>测试结果</span>
                        <label id='result-desc' lang="en"></label>
                    </div>
                    <div class="info-value">
                        <span lang="en">Steps: </span><strong>{{data.steps|length}}</strong> &nbsp;&nbsp;
                        <span lang="en">Duration: </span><strong class="duration"></strong>
                    </div>
                </div>
            </div>
            <div class="info-block">
                <div class="info-icon">
                    <img src="{{static_root}}image/calendar.svg" alt="time">
                </div>
                <div class="info-text">
                    <div class="info-title"><span lang='en'>执行时间</span></div>
                    <div class="info-value">
                        <span class="start-time"></span> - <span class="end-time"></span>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="steps-container">
            <div class="step-left">
                <ul class="step-list"></ul>
                <div id="pageTool"></div>
            </div>
            <div class="step-right">
                <div class="step-right-header">
                    <div class="step-title-display">步骤详情</div>
                    <div class="step-filters">
                        <span class="filter active" data-filter="all">全部</span>
                        <span class="filter" data-filter="success">成功</span>
                        <span class="filter" data-filter="fail">失败</span>
                        <span class="filter" data-filter="assert">断言</span>
                        <span class="filter" id="jump-wrong">跳至错误</span>
                    </div>
                </div>
                <div class="step-detail-container">
                    <p>请从左侧列表中选择一个步骤以查看详细信息。</p>
                </div>
            </div>
        </div>
    </div>
    
    <div id="magnify"><img src=""></div>
    
    <script type="text/javascript">
      var data = {{data|safe}};
      var lang = new Lang();
      lang.init({
        defaultLang: 'en',
        currentLang: '{{ lang }}'
      });
    </script>
    <script src="{{static_root}}js/highlight.min.js"></script>
    <script src="{{static_root}}js/paging.js"></script>
    
    <script type="text/javascript">
    
    var current_step_data = null;

    function getDelta(end, start) {
        return (end - start) * 1000;
    }

    function getFormatDuration(delta) {
        var ms = parseInt(delta % 1000);
        var s = parseInt((delta / 1000) % 60);
        var m = parseInt((delta / (1000 * 60)) % 60);
        var h = parseInt(delta / (1000 * 60 * 60));
        var msg = '';
        if (h > 0) msg += h + 'h ';
        if (m > 0) msg += m + 'm ';
        if (s > 0) msg += s + 's ';
        return msg + ms + 'ms';
    }

    $(document).ready(function() {
        var result = data.test_result ? 'success' : 'fail';
        var result_text = result.charAt(0).toUpperCase() + result.slice(1);
        $('#result-desc').addClass(result).text(result_text);
        $('#result-img').attr('src', '{{static_root}}image/step_' + result + '.svg');
        
        var startTime = new Date(data.run_start * 1000);
        var endTime = new Date(data.run_end * 1000);
        
        $('.start-time').text(startTime.toLocaleString());
        $('.end-time').text(endTime.toLocaleString());
        $('.duration').text(getFormatDuration(getDelta(data.run_end, data.run_start)));
        
        var step_list = $(".step-list");
        var has_assert = false;
        var currentWrong = -1;

        $.each(data.steps, function(index, step) {
            step.index = index;
            step.duration_ms = (index > 0) ? getDelta(step.time, data.steps[index-1].time) : getDelta(step.time, data.run_start);
            step.duration = getFormatDuration(step.duration_ms);

            var step_class = step.traceback ? 'fail' : 'success';
            if (step.assert) {
                step_class += ' assert';
                has_assert = true;
            }
            var icon_src = '{{static_root}}image/step_' + (step.traceback ? 'fail' : 'success') + '.svg';
            var title = step.desc || step.title || (step.code ? step.code.name : 'step ' + (index + 1));

            var li = $('<li>').addClass(step_class).data('step-data', step);
            li.html('<span class="order"># ' + (index + 1) + '</span>' +
                      '<img src="' + icon_src + '" class="step-icon">' +
                      '<span class="step-title">' + title + '</span>' +
                      '<span class="step-time">' + step.duration + '</span>');
            step_list.append(li);
        });

        step_list.on('click', 'li', function() {
            step_list.find('li').removeClass('active');
            $(this).addClass('active');
            renderStepDetail($(this).data('step-data'));
        });
        
        $('.filter').on('click', function(){
            if ($(this).is('#jump-wrong')) return;
            $('.filter').removeClass('active');
            $(this).addClass('active');
            var filter = $(this).data('filter');
            
            step_list.find('li').show();
            if(filter !== 'all'){
                step_list.find('li:not(.' + filter + ')').hide();
            }
            var firstVisible = step_list.find('li:visible').first();
            if (firstVisible.length > 0) {
                 firstVisible.trigger('click');
            } else {
                 renderStepDetail(null);
            }
        });

        $('#jump-wrong').on('click', function() {
            var wrong_steps = step_list.find('li.fail');
            if (wrong_steps.length > 0) {
                currentWrong = (currentWrong + 1) % wrong_steps.length;
                var target_step = $(wrong_steps[currentWrong]);

                $('.filter[data-filter="all"]').click();
                
                target_step.click();

                 var container = $('.step-left');
                 container.scrollTop(
                    target_step.offset().top - container.offset().top + container.scrollTop() - 20
                 );
            }
        });

        if(has_assert){
            $('.filter[data-filter="assert"]').trigger('click');
        } else {
            $('.filter[data-filter="all"]').trigger('click');
        }

        if (data.steps.length > 0) {
            step_list.find('li:visible').first().trigger('click');
        }
        
        $(document).on('click', '.step-detail img', function() {
            $('#magnify img').attr('src', $(this).attr('src'));
            $('#magnify').css('display', 'flex');
        });

        $('#magnify').on('click', function() {
            $(this).hide();
        });

        var resize_timer;
        $(window).on('resize', function() {
            clearTimeout(resize_timer);
            resize_timer = setTimeout(function() {
                if (current_step_data) {
                    updateMarkerPositions(current_step_data);
                }
            }, 200);
        });
    });

    function updateMarkerPositions(step) {
        if (step && step.screen && step.screen.src) {
            var fancybox = $('.step-detail .fancybox');
            var img = fancybox.find('img');

            if (img.length > 0 && img[0].naturalWidth > 0) {
                var scale = img.width() / (step.screen.resolution ? step.screen.resolution[0] : img[0].naturalWidth);
                
                fancybox.find('.target').each(function(index) {
                    var pos = step.screen.pos[index];
                    $(this).css({
                        left: (pos[0] * scale - 20) + 'px',
                        top: (pos[1] * scale - 20) + 'px'
                    });
                });

                fancybox.find('.rect').each(function(index) {
                    var rect = step.screen.rect[index];
                    $(this).css({
                        left: rect.left * scale + 'px',
                        top: rect.top * scale + 'px',
                        width: rect.width * scale + 'px',
                        height: rect.height * scale + 'px'
                    });
                });
            }
        }
    }

    function renderStepDetail(step) {
        var detail_container = $(".step-detail-container");
        detail_container.empty();
        current_step_data = step;

        if(!step) {
            $('.step-title-display').text("步骤详情");
            detail_container.html("<p>请从左侧列表中选择一个步骤以查看详细信息。</p>");
            return;
        }
        
        var title = step.desc || step.title || (step.code ? step.code.name : 'step');
        $('.step-title-display').text(title);
        
        var content = $('<div>').addClass('step-detail');

        if (step.code) {
            var code_html = '<strong>Code:</strong><pre><code>' + step.code.name + '(';
            var args_list = [];
            if (step.code.args && step.code.args.length) {
                step.code.args.forEach(function(arg) {
                    var val = arg.value;
                    if (typeof val === 'object') val = JSON.stringify(val);
                    args_list.push('<span>' + arg.key + '</span>' + '=' + '<span>' + val + '</span>');
                });
            }
            code_html += args_list.join(', ') + ')</code></pre>';
            content.append($('<div>').addClass('code-line').html(code_html));
        }

        if (step.code && step.code.args && step.code.args.length > 0) {
            var args_content = $('<div>').addClass('args-line');
            var has_visible_args = false;
            
            step.code.args.forEach(function(arg) {
                if (arg.image) {
                    if (!has_visible_args) {
                        args_content.append('<strong>Args:</strong>');
                        has_visible_args = true;
                    }
                    args_content.append('<div><img class="crop_image" src="' + arg.image + '" title="arg: ' + arg.key + '" onerror="this.parentElement.style.display=\'none\'"></div>');
                }
            });

            if(has_visible_args) {
                 content.append(args_content);
            }
        }
        
        if (step.screen && step.screen.src) {
            var fancybox = $('<div class="fancybox"></div>');
            var img = $('<img>').attr('src', step.screen.src).attr('onerror', "this.parentElement.style.display='none'");
            fancybox.append(img);

            img.on('load', function() { updateMarkerPositions(step); });
            content.append(fancybox);

            if(step.screen.pos && step.screen.pos.length){
                step.screen.pos.forEach(function(){ fancybox.append($('<div class="target"></div>')); });
            }
            if(step.screen.rect && step.screen.rect.length){
                step.screen.rect.forEach(function(){ fancybox.append($('<div class="rect"></div>')); });
            }
        }

        if (step.log) {
            content.append($('<div>').addClass('log-line').html('<strong>Log:</strong><pre><code>' + JSON.stringify(step.log, null, 2) + '</code></pre>'));
        }

        if (step.traceback) {
             content.append($('<div>').addClass('traceback').html('<strong>Traceback:</strong><pre><code>' + step.traceback + '</code></pre>'));
        }
        
        detail_container.append(content);
        
        detail_container.find('.log-line pre code, .traceback pre code').each(function(i, block) {
            hljs.highlightBlock(block);
        });
    }
    </script>
</body>
</html>