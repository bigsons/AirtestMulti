<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>执行报告{{info.title}}</title>
    <script src="{{static_root}}js/jquery-1.10.2.min.js"></script>
    <script src="{{ static_root }}js/jquery-lang.js" charset="utf-8" type="text/javascript"></script>
    <script src="{{ static_root }}js/langpack/zh_CN.js" charset="utf-8" type="text/javascript"></script>
    <script src="{{ static_root }}js/lazyload.js" charset="utf-8" type="text/javascript"></script>
    <link href="{{static_root}}css/monokai_sublime.min.css" rel="stylesheet">
    
    <style type="text/css">
        /* Enhanced Report Theme - Inspired by Network Map UI */
        :root {
            /* Color Palette */
            --bg-color: #f4f4f4;
            --panel-bg: #ffffff; 
            --border-color: #e6e8eb;
            --primary-color: #4acbd6;
            --primary-hover-color: #1794bc;
            --active-color: #4acbd626;
            --active-text-color: #36444b;
            --text-color: #1d2529;
            --text-color-secondary: #a7a9ac;
            --success-color: #28a745;
            --fail-color: #dc3545;
            --card-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            font-size: 14px;
            line-height: 1.6;
            color: var(--text-color);
            background-color: var(--bg-color);
            margin: 0;
            min-width: 600px;
        }

        .container-fluid {
            width: 90%; 
            max-width: 1400px;
            min-width: 800px;
            margin: 15px auto;
            background-color: var(--panel-bg);
            border-radius: 12px; /* 更大的圆角 */
            box-shadow: var(--card-shadow);
            border: 1px solid var(--border-color);
            padding: 20px 30px;
        }

        .title {
            font-size: 28px;
            font-weight: 600;
            color: var(--text-color);
            text-align: center;
            padding-bottom: 15px;
            margin: 5px 0 15px 0;
            border-bottom: 1px solid var(--border-color);
        }

        .summary {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 15px;
            margin-bottom: 15px;
        }
        
        .summary .info-block {
            flex: 1 1 300px;
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .summary .info-icon img {
            width: 48px;
            height: 48px;
        }
        
        .summary .info-text .info-title {
            font-size: 16px;
            font-weight: 500;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
        }
        
        .summary .info-text .info-value {
            font-size: 14px;
            color: var(--text-color-secondary);
        }

        .summary .info-text .info-value strong {
            color: var(--text-color);
            font-weight: 500;
        }

        #result-desc {
            padding: 4px 12px;
            border-radius: 12px;
            color: #fff;
            font-size: 14px;
            font-weight: bold;
            margin-left: 10px;
        }
        
        #result-desc.success { background-color: var(--success-color); }
        #result-desc.fail { background-color: var(--fail-color); }
        
        .copy-img {
            height: 15px;
            cursor: pointer;
            margin-left: 8px;
            vertical-align: middle;
            opacity: 0.6;
            transition: opacity 0.2s;
        }
        .copy-img:hover { opacity: 1; }

        .steps-wrapper {
            display: flex;
            gap: 5px;
            min-height: 500px;
            height: calc(100vh - 220px);
        }
        
        .step-panel-wrapper {
            border: 1px solid var(--border-color);
            border-radius: 10px; /* 更大的圆角 */
            background: var(--panel-bg);
            box-shadow: none; /* 移除内层阴影，整体更扁平 */
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .steps-left-wrapper {
            flex: 0 0 300px;
        }

        .steps-right-wrapper {
            flex: 1;
            min-width: 0;
        }
        
        .step-list { 
            list-style: none; 
            padding: 0; 
            margin: 0;
            overflow-y: auto;
            flex-grow: 1;
        }
        .step-list li {
            padding: 11px 20px;
            cursor: pointer;
            border-bottom: 1px solid var(--border-color);
            transition: background-color 0.2s;
            display: flex;
            align-items: center;
        }
        .step-list li:last-child {
            border-bottom: none;
        }
        .step-list li:hover { background-color: #f0f8ff; }
        /* --- 核心修改点：选中状态 --- */
        .step-list li.active { 
            background-color: var(--active-color); 
            color: var(--active-text-color); 
            font-weight: 600;
        }
        .step-list li.active .step-title, .step-list li.active .step-time { color: var(--active-text-color); }

        .step-list .step-icon {
            margin-right: 12px;
            width: 18px;
            height: 18px;
            flex-shrink: 0;
        }

        .step-list .step-title {
            flex-grow: 1;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        .step-list .step-time {
            color: var(--text-color-secondary);
            font-size: 12px;
            white-space: nowrap;
            margin-left: 15px;
        }
        
        .step-panel-header {
            padding: 15px 20px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #fafbfc; /* 更亮的头部背景 */
            flex-shrink: 0;
        }
        
        .step-title-display {
            font-size: 18px;
            font-weight: 600;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            flex: 1;
            min-width: 0;
        }
        
        .step-filters .filter {
            cursor: pointer;
            padding: 6px 16px;
            border-radius: 15px;
            margin-left: 10px;
            font-size: 13px;
            border: 1px solid #d9d9d9;
            transition: all 0.2s;
        }
        .step-filters .filter:hover {
            border-color: var(--primary-hover-color);
            color: var(--primary-hover-color);
        }
        .step-filters .filter.active {
            background-color: var(--primary-color);
            color: #fff;
            border-color: var(--primary-color);
        }
        
        #jump-wrong {
            background-color: var(--fail-color);
            color: white;
            border-color: var(--fail-color);
            padding: 6px 16px;
            font-size: 13px;
        }
        
        #jump-wrong:hover {
            opacity: 0.85;
        }

        #jump-wrong.disabled {
            background-color: #ccc;
            border-color: #ccc;
            cursor: not-allowed;
            opacity: 0.6;
        }
        
        .step-detail-container {
            padding: 25px;
            overflow-y: auto;
            flex-grow: 1;
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        .step-detail-container::-webkit-scrollbar {
            display: none;
        }
        
        .step-detail {
            max-width: 1100px;
            margin: 0 auto;
        }
        
        .step-detail .step-info {
            display: grid;
            grid-template-columns: repeat(4, 1fr); 
            gap: 20px;
            margin-bottom: 20px;
            padding-bottom: 20px;
            border-bottom: 1px solid var(--border-color);
        }

        .step-detail .info-item span { display: block; }
        .step-detail .info-item .label { color: var(--text-color-secondary); font-size: 14px;}
        .step-detail .info-item .value { font-weight: 500; font-size: 14px; }
        .step-detail .info-item .value.fail { color: var(--fail-color); }
        .step-detail .info-item .value.success { color: var(--success-color); }
        
        .step-detail .code-line, .step-detail .log-line, .step-detail .traceback, .step-detail .assert, .step-detail .args-line {
            margin-bottom: 20px;
        }
        
        .step-detail strong {
            display: block;
            margin-bottom: 10px;
            font-size: 15px;
            color: var(--text-color);
        }
        
        pre {
            padding: 15px;
            border-radius: 6px;
            white-space: pre-wrap;
            word-wrap: break-word;
            margin: 0;
            font-family: "SFMono-Regular", Consolas, "Liberation Mono", Menlo, Courier, monospace;
            font-size: 13px;
            border: 1px solid #eee;
        }

        .step-detail .code-line pre { background-color: #fdfdfd; }
        .step-detail .log-line pre { background-color: #272822; color: #f8f8f2; }
        .step-detail .traceback pre { background-color: #fff0f6; color: var(--fail-color); border: 1px solid #ffadd2; } 
        .step-detail .assert { display: none; }
        
        .step-detail .fancybox {
            position: relative;
            display: inline-block;
            margin-top: 10px;
        }

        .step-detail img, .step-detail .crop_image {
            max-width: 100%;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            cursor: zoom-in;
            box-shadow: 0 2px 8px rgba(0,0,0,0.07);
        }

        .target {
            position: absolute;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            box-sizing: border-box;
        }
        
        .target::before, .target::after {
            content: '';
            display: block;
            position: absolute;
            top: 50%;
            left: 50%;
            width: 100%;
            height: 100%;
            border-radius: 50%;
            border: 1px solid var(--active-color); 
            transform: translate(-50%, -50%);
            animation: target-ripple 1.5s infinite ease-out;
        }
        
        .target::after { animation-delay: 0.5s; }

        .rect {
            position: absolute;
            border: 2px solid var(--fail-color);
            background-color: rgba(193, 28, 102, 0.2); /* 配合新的失败颜色 */
        }

        @keyframes target-ripple {
            from { transform: translate(-50%, -50%) scale(1); opacity: 0.8; }
            to { transform: translate(-50%, -50%) scale(2.5); opacity: 0; }
        }

        .footer { text-align: center; padding: 25px; color: var(--text-color-secondary); font-size: 12px; }

        #magnify {
            position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
            background: rgba(0,0,0,0.85); z-index: 1000;
            display: none; justify-content: center; align-items: center;
            cursor: zoom-out;
        }
        #magnify img { max-width: 95%; max-height: 95%; border: 2px solid #fff; border-radius: 5px; }

        @media (max-width: 1200px) {
            .container-fluid {
                width: 90%;
                min-width: 600px;
            }
        }

        @media (max-width: 992px) {
            .steps-wrapper { flex-direction: column; height: auto; gap: 20px; }
            .steps-left-wrapper { flex-basis: auto; max-height: 40vh; }
            .steps-right-wrapper { flex-basis: auto; max-height: 60vh; }
            .summary .info-block { flex-basis: 100%; }
        }
    </style>
</head>

<body>
    <div class="container-fluid">
        <h1 class="title" lang="en">Script Execution Report</h1>

        <div class="summary">
            <div class="info-block">
                <div class="info-icon">
                    <img id="result-img" src="" alt="result">
                </div>
                <div class="info-text">
                    <div class="info-title">
                        <span lang='en'>Test Result</span>
                        <label id='result-desc' lang="en"></label>
                    </div>
                    <div class="info-value">
                        <span lang="en">Steps: </span><strong>{{steps|length}}</strong> &nbsp;&nbsp;
                        <span lang="en">Duration: </span><strong class="duration"></strong>
                    </div>
                </div>
            </div>
            <div class="info-block">
                <div class="info-icon">
                    <img src="{{static_root}}image/time.svg" alt="time">
                </div>
                <div class="info-text">
                    <div class="info-title"><span lang='en'>Execution Time</span></div>
                    <div class="info-value">
                        <span class="start-time"></span> - <span class="end-time"></span>
                    </div>
                </div>
            </div>
             <div class="info-block">
                <div class="info-icon">
                    <img src="{{static_root}}image/device.svg" alt="device">
                </div>
                <div class="info-text">
                    <div class="info-title"><span lang='en'>Device & Script</span></div>
                    <div class="info-value">
                        {% if info.devices %}
                            {% set devices_str=info.devices.values() | join(',') %}
                            <span title="{{ devices_str }}">
                                <strong>Device: </strong> {{info.devices.keys() | join(',') }}
                                <img class="copy-img" title="copy device string" src="{{static_root}}image/copy.svg" data-value="{{ devices_str }}"/>
                            </span>
                        {% endif %}
                        <span title="{{info.path}}">
                            <strong>Script: </strong>
                            {{info.name}}
                            <img class="copy-img" data-value="{{info.path}}" title="copy file path" src="{{static_root}}image/copy.svg" />
                        </span>
                    </div>
                </div>
            </div>
        </div>

        <div class="steps-wrapper">
            <div class="steps-left-wrapper step-panel-wrapper">
                <div class="step-panel-header">
                    <span class="step-title-display" lang="en">Steps</span>
                </div>
                <ul class="step-list"></ul>
                <div id="pageTool"></div>
            </div>
            <div class="steps-right-wrapper step-panel-wrapper">
                <div class="step-panel-header">
                    <div class="step-title-display">Step Details</div>
                    <div class="step-filters">
                        <span class="filter active" data-filter="all" lang="en">All</span>
                        <span class="filter" data-filter="success" lang="en">Success</span>
                        <span class="filter" data-filter="fail" lang="en">Fail</span>
                        <span class="filter" data-filter="assert" lang="en">Assert</span>
                        <span class="filter" id="jump-wrong" lang="en">Jump to Error</span>
                    </div>
                </div>
                <div class="step-detail-container">
                    <p>Select a step from the list on the left to see details.</p>
                </div>
            </div>
        </div>
    </div>
    
    <div id="magnify">
        <img src="">
    </div>
    
    <script type="text/javascript">
      var data = {{data|safe}};
      var lang = new Lang();
      lang.init({
        defaultLang: 'en',
        currentLang: '{{ lang }}'
      });
    </script>
    <script src="{{static_root}}js/highlight.min.js"></script>
    <script src="{{static_root}}js/paging.js"></script>
    
    <script type="text/javascript">
    
    var current_step_data = null; 

    function updateJumpButtonState() {
        var hasAnyErrors = $('.step-list li.fail').length > 0;
        var jumpButton = $('#jump-wrong');
        if (hasAnyErrors) {
            jumpButton.removeClass('disabled').prop('disabled', false);
        } else {
            jumpButton.addClass('disabled').prop('disabled', true);
        }
    }

    $(document).ready(function() {
        $.each(data.steps, function(index, step) {
            step.duration_ms = (index > 0) ? (step.time - data.steps[index - 1].time) * 1000 : (step.time - data.run_start) * 1000;
            step.duration = (step.duration_ms / 1000).toFixed(2) + 's';
        });

        var result = data.test_result ? 'success' : 'fail';
        $('#result-desc').addClass(result).text(result.charAt(0).toUpperCase() + result.slice(1));
        $('#result-img').attr('src', '{{static_root}}image/' + result + '.svg');
        
        var startTime = new Date(data.run_start * 1000);
        var endTime = new Date(data.run_end * 1000);
        var total_duration = ((data.run_end - data.run_start)).toFixed(2) + 's';

        $('.start-time').text(startTime.toLocaleString());
        $('.end-time').text(endTime.toLocaleString());
        $('.summary .duration').text(total_duration);
        
        var step_list = $(".step-list");
        var has_assert = false;
        var currentWrong = -1;

        $.each(data.steps, function(index, step) {
            step.index = index;
            var step_class = step.traceback ? 'fail' : 'success';
            if (step.assert) {
                step_class += ' assert';
                has_assert = true;
            }
            var icon_src = '{{static_root}}image/step_' + (step.traceback ? 'fail' : 'success') + '.svg';
            var title = step.desc || step.title || (step.code ? step.code.name : 'step ' + (index + 1));
            var time_str = new Date(step.time * 1000).toLocaleTimeString();

            var li = $('<li>').addClass(step_class).data('step-data', step);
            li.html('<img src="' + icon_src + '" class="step-icon">' +
                      '<span class="step-title">#' + (index + 1) + ' ' + title + '</span>' +
                      '<span class="step-time">' + time_str + '</span>');
            step_list.append(li);
        });

        step_list.on('click', 'li', function() {
            step_list.find('li').removeClass('active');
            $(this).addClass('active');
            renderStepDetail($(this).data('step-data'));
        });
        
        $('.filter').on('click', function(){
            if ($(this).is('#jump-wrong')) return;
            $('.filter').removeClass('active');
            $(this).addClass('active');
            var filter = $(this).data('filter');
            
            step_list.find('li').show();
            if(filter !== 'all'){
                step_list.find('li:not(.' + filter + ')').hide();
            }
            
            var firstVisible = step_list.find('li:visible').first();
            if (firstVisible.length > 0) {
                 firstVisible.trigger('click');
            } else {
                 renderStepDetail(null);
            }
        });

        $('#jump-wrong').on('click', function() {
            if ($(this).hasClass('disabled')) return;
            var wrong_steps = step_list.find('li.fail:visible');
            
            if (wrong_steps.length > 0) {
                currentWrong = (currentWrong + 1) % wrong_steps.length;
                var target_step = $(wrong_steps[currentWrong]);
                target_step.click();
                 var container = $('.step-list');
                 container.scrollTop(
                    target_step.offset().top - container.offset().top + container.scrollTop() - 20
                 );
            } else {
                var all_wrong_steps = step_list.find('li.fail');
                if (all_wrong_steps.length > 0) {
                    $('.filter[data-filter="all"]').click();
                    currentWrong = 0;
                    var target_step = $(all_wrong_steps[currentWrong]);
                    target_step.click();
                    var container = $('.step-list');
                    container.scrollTop(
                        target_step.offset().top - container.offset().top + container.scrollTop() - 20
                    );
                }
            }
        });

        if(has_assert){
            $('.filter[data-filter="assert"]').trigger('click');
        } else {
            $('.filter[data-filter="all"]').trigger('click');
        }
        
        updateJumpButtonState(); 

        if (data.steps.length > 0) {
            step_list.find('li:visible').first().trigger('click');
        }
        
        $(document).on('click', '.step-detail img, .copy-img', function(e) {
            if ($(this).hasClass('copy-img')) {
                e.stopPropagation();
                var text_to_copy = $(this).data('value');
                var temp_input = $('<input>');
                $('body').append(temp_input);
                temp_input.val(text_to_copy).select();
                document.execCommand('copy');
                temp_input.remove();
            } else {
                $('#magnify img').attr('src', $(this).attr('src'));
                $('#magnify').css('display', 'flex');
            }
        });

        $('#magnify').on('click', function() {
            $(this).hide();
        });

        var resize_timer;
        $(window).on('resize', function() {
            clearTimeout(resize_timer);
            resize_timer = setTimeout(function() {
                if (current_step_data) {
                    updateMarkerPositions(current_step_data);
                }
            }, 200);
        });
    });

    function updateMarkerPositions(step) {
        if (step && step.screen && step.screen.src) {
            var fancybox = $('.step-detail .fancybox');
            var img = fancybox.find('img');

            if (img.length > 0 && img[0].naturalWidth > 0) { 
                var scale = img.width() / (step.screen.resolution ? step.screen.resolution[0] : img[0].naturalWidth);
                
                fancybox.find('.target').each(function(index) {
                    var pos = step.screen.pos[index];
                    $(this).css({
                        left: (pos[0] * scale - 10) + 'px',
                        top: (pos[1] * scale - 10) + 'px'
                    });
                });

                fancybox.find('.rect').each(function(index) {
                    var rect = step.screen.rect[index];
                    $(this).css({
                        left: rect.left * scale + 'px',
                        top: rect.top * scale + 'px',
                        width: rect.width * scale + 'px',
                        height: rect.height * scale + 'px'
                    });
                });
            }
        }
    }

    function renderStepDetail(step) {
        var detail_container = $(".step-detail-container");
        detail_container.empty();
        current_step_data = step;

        if(!step) {
            $('.steps-right-wrapper .step-title-display').text("Step Details").attr('title', 'Step Details');
            detail_container.html("<p>Select a step from the list on the left to see details.</p>");
            return;
        }
        
        var title = step.desc || step.title || (step.code ? step.code.name : 'step');
        $('.steps-right-wrapper .step-title-display').text(title).attr('title', title);
        
        var content = $('<div>').addClass('step-detail');

        var status_class = step.traceback ? 'fail' : 'success';
        var status_text = step.traceback ? 'Failed' : 'Success';
        var info_html = `
            <div class="step-info">
                <div class="info-item">
                    <span class="label">Step</span>
                    <span class="value">#${step.index + 1}</span>
                </div>
                <div class="info-item">
                    <span class="label">Status</span>
                    <span class="value ${status_class}">${status_text}</span>
                </div>
                <div class="info-item">
                    <span class="label">Action</span>
                    <span class="value">${step.code ? step.code.name : 'N/A'}</span>
                </div>
                <div class="info-item">
                    <span class="label">Duration</span>
                    <span class="value">${step.duration}</span>
                </div>
            </div>
        `;
        content.append(info_html);

        if (step.code) {
            var code_html = '<strong>Code:</strong><pre><code>' + step.code.name + '(';
            var args_list = [];
            if (step.code.args && step.code.args.length) {
                step.code.args.forEach(function(arg) {
                    var val = arg.value;
                    if (typeof val === 'object') val = JSON.stringify(val);
                    args_list.push('<span>' + arg.key + '</span>' + '=' + '<span>' + val + '</span>');
                });
            }
            code_html += args_list.join(', ') + ')</code></pre>';
            content.append($('<div>').addClass('code-line').html(code_html));
        }

        if (step.code && step.code.args && step.code.args.length > 0) {
            var args_content = $('<div>').addClass('args-line');
            var has_visible_args = false;
            
            args_content.append('<strong>Args:</strong>');

            step.code.args.forEach(function(arg) {
                if (arg.image) {
                    args_content.append('<div><img class="crop_image" src="' + arg.image + '" title="arg: ' + arg.key + '" onerror="this.parentElement.style.display=\'none\'"></div>');
                    has_visible_args = true;
                }
            });

            if(has_visible_args) {
                 content.append(args_content);
            }
        }
        
        if (step.screen && step.screen.src) {
            var fancybox = $('<div class="fancybox"></div>');
            var img = $('<img>').attr('src', step.screen.src).attr('onerror', "this.parentElement.style.display='none'");
            fancybox.append(img);

            img.on('load', function() {
                updateMarkerPositions(step);
            });
            content.append(fancybox);

            if(step.screen.pos && step.screen.pos.length){
                step.screen.pos.forEach(function(){
                    fancybox.append($('<div class="target"></div>'));
                });
            }
            if(step.screen.rect && step.screen.rect.length){
                step.screen.rect.forEach(function(){
                    fancybox.append($('<div class="rect"></div>'));
                });
            }
        }

        if (step.log) {
            var log_content = step.log;
            if (typeof log_content === 'object') {
                log_content = JSON.stringify(log_content, null, 2);
            }
            content.append($('<div>').addClass('log-line').html('<strong>Log:</strong><pre><code>' + log_content + '</code></pre>'));
        }

        if (step.traceback) {
             content.append($('<div>').addClass('traceback').html('<strong>Traceback:</strong><pre><code>' + step.traceback + '</code></pre>'));
        }
        
        if (step.assert) {
             content.append($('<div>').addClass('assert').html('<strong>Assert:</strong><pre>' + step.assert + '</pre>'));
        }
        
        detail_container.append(content);
        
        detail_container.find('.log-line pre code, .traceback pre code').each(function(i, block) {
            hljs.highlightBlock(block);
        });
    }
    </script>
</body>
</html>